# stacks/pihole-unbound/docker-compose.yml
version: '3.9'

services:
  pihole:
    image: pihole/pihole:2024.07.0
    container_name: pihole
    hostname: pihole
    depends_on:
      - unbound
    ports:
      - 53:53
      - 1010:80
    environment:
      - PIHOLE_UID=${PUID}
      - PIHOLE_GID=${PGID}
      - WEBPASSWORD=${PIHOLE_WEBPASSWORD}
      - DNSMASQ_LISTENING=${PIHOLE_DNSMASQ_LISTENING}
      - TZ=${PIHOLE_TZ:-IST}
      - CUSTOM_CACHE_SIZE=${PIHOLE_CACHE_SIZE}
      - IPv6=false
      - PIHOLE_DNS_=unbound
      - DNS_BOGUS_PRIV=true
      - DNS_FQDN_REQUIRED=true
      - WEBTHEME=high-contrast-dark
    volumes:
      - "${PIHOLE_VOLUME_PATH}:/etc/pihole/:rw"
      - "${PIHOLE_VOLUME_PATH}/dnsmasq.d:/etc/dnsmasq.d/:rw"
    networks:
      - domain-name-server
    restart: unless-stopped
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1'
          memory: '1024M'
        reservations:
          cpus: '0.1'
          memory: '64M'
  unbound:
    container_name: unbound
    image: mvance/unbound:1.20.0
    hostname: unbound
    volumes:
      - "${UNBOUND_VOLUME_PATH}/forward-records.conf:/opt/unbound/etc/unbound/forward-records.conf:ro"
      - "${UNBOUND_VOLUME_PATH}/a-records.conf:/opt/unbound/etc/unbound/a-records.conf:ro"
      - "${UNBOUND_VOLUME_PATH}/srv-records.conf:/opt/unbound/etc/unbound/srv-records.conf:ro"
    networks:
      - domain-name-server
    restart: unless-stopped
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1'
          memory: '1024M'
        reservations:
          cpus: '0.1'
          memory: '64M'

networks:
  domain-name-server:
    name: "dns"
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.22.53.0/24
    external: false
